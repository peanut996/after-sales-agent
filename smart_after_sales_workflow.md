# 智能售后处理工具 - 执行流程

## 订单自动处理规则

### 适用条件
- ✅ **商品类型**：仅处理"自助工具"类商品（如：拼豆图自助工具【10次】等）
- ✅ 售后类型：已发货仅退款
- ✅ 状态：待商家审核

### 筛选标准
- 商品名称包含"自助工具"关键词
- 仅处理数字化商品，不处理实物商品

## 自动化处理流程

### 第一步：获取订单信息
1. 打开售后订单列表页面（https://ark.xiaohongshu.com/app-order/aftersale/list）
2. 使用 `opera-item` class 筛选器定位"查看详情"按钮
3. 点击"查看详情"按钮进入售后详情页

### 第二步：提取访问码
1. 在售后详情页的"发货物流"模块中查找发货内容链接
2. 链接格式：`https://ghibliflowstudio.com/?c={访问码}`
3. 提取链接中的访问码（如：75babb7f2f）

### 第三步：查询访问码剩余次数
执行API调用：
```bash
curl --location --request GET 'https://ghibliflowstudio.com/api/access-codes/{访问码}' \
--header 'Content-Type: application/json'
```

返回结果示例：
```json
{
  "code": "75babb7f2f",
  "usesRemaining": 10,
  "isActive": true,
  "processingMode": "api"
}
```

### 第四步：决策判断
- **仅当商品为"自助工具"类时执行自动处理**
- **情况一**：商品规格中标注的使用次数 = API查询的剩余次数
  - 处理动作：直接同意退款（执行第五步）
- **情况二**：商品规格中标注的使用次数 ≠ API查询的剩余次数
  - 处理动作：按比例部分退款（执行第六步）
- **情况三**：非自助工具商品
  - 处理动作：跳过自动处理，需人工审核

### 第五步：执行全额退款操作
1. 在售后详情页点击"同意退款"按钮
2. 在弹窗中点击"确定退款"按钮
3. 确认退款状态变更为"已同意退款"

### 第六步：执行按比例部分退款操作
**计算退款金额：**
- 单次价格 = 商品总价 ÷ 标注总次数
- 已使用次数 = 标注总次数 - 剩余次数
- 可退金额 = 单次价格 × (标注总次数 - 已使用次数)
- 示例：生图10次 × ¥0.5/次 = ¥5.00，剩余8次，已使用2次，可退金额 = ¥5.00 × (10-2)/10 = ¥4.00

**操作流程：**
1. 首先尝试点击"拒绝"按钮
   - 拒绝原因选择"其他"
   - 拒绝说明输入：`已使用{已使用次数}次，可退剩余部分{可退金额}元`

2. 如果系统提示需要协商，转为协商流程：
   - **首先点击【经协商部分退款】**
   - **切换【售后类型】选择与原类型不同的选项：**
     - 原"仅退款 未收到货" → 选"仅退款 已收到货"
     - 原"仅退款 已收到货" → 选"仅退款 未收到货"
   - **修改【售后原因】选择"其他"**
   - **修改【售后金额】填入计算的金额**
   - **点击【自定义文案】修改文本为：`已使用{已使用次数}次，可退剩余部分{可退金额}元`**
   - **勾选【协商超时自动拒绝】**
   - **选择【拒绝原因-其他】**
   - **填写【拒绝说明】为：`已使用{已使用次数}次，可退剩余部分{可退金额}元`**
   - **点击【确认发送】**

3. **如果已协商时间已经超出半个小时，可以详情页面直接点击拒绝**

### 第七步：关闭订单页面并继续处理
1. 完成退款操作后，关闭当前售后详情页
2. 返回售后订单列表页面
3. 继续处理下一个待审核订单

---

## 实际案例记录

### 订单 P778419274809061521

**订单信息：**
- 售后单号：R0906152167392389
- 商品：拼豆图自助工具【10次】（规格：生图10次）
- 申请金额：¥4.99
- 售后原因：其他（买家说明：还没有用，太麻烦了）

**发货内容：**
- 链接：https://ghibliflowstudio.com/?c=75babb7f2f
- 访问码：75babb7f2f

**API查询结果：**
- 剩余次数：10次
- 状态：激活中
- 处理模式：API模式

**决策判断：**
- ✅ 商品标注：生图10次
- ✅ API查询：剩余10次
- **结论：符合条件，直接退款**

**处理结果：**
- 操作：点击同意退款 → 确认退款
- 状态：已同意退款
- 退款金额：¥4.99
- 退款时间：0天23时59分内退至原支付账号
- 处理时间：2025-11-11 22:31:41

---

## 注意事项
1. **商品筛选**：仅处理商品名称包含"自助工具"的订单，其他商品需人工处理
2. 每次处理前需要刷新页面确保数据最新
3. 使用 `opera-item` class 精确筛选"查看详情"按钮，减少DOM元素定位时间
4. 完成订单处理后必须关闭订单详情页，避免页面堆积影响性能
5. 确保API调用成功且返回正确的剩余次数
6. 严格比对商品规格中的次数和API返回的剩余次数
7. **按比例退款计算**：使用公式精确计算退款金额，避免金额错误
8. **协商话术**：使用标准化文案"已使用X次，可退剩余部分X.X元"
9. 如果访问码无效或API调用失败，需要人工处理
10. 建议批量处理前先测试单个订单流程

## 待优化点
1. 可以考虑集成批量API查询功能，提高处理效率
2. 添加异常情况处理日志
3. 支持更多商品类型和判断规则
