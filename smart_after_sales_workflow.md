# 智能售后处理工具 - 执行流程

## 订单自动处理规则

### 适用条件
- ✅ **商品类型**：仅处理"自助工具"类商品（如：拼豆图自助工具【10次】等）
- ✅ 售后类型：已发货仅退款
- ✅ 状态：待商家审核

### 筛选标准
- 商品名称包含"自助工具"关键词
- 仅处理数字化商品，不处理实物商品

## 自动化处理流程

### 第一步：获取订单信息
1. 打开售后订单列表页面（https://ark.xiaohongshu.com/app-order/aftersale/list）
2. 使用 `toolbarAndList` class 定位列表页面
3. 使用 `opera-item` class 筛选器定位"查看详情"按钮
4. 点击"查看详情"按钮进入售后详情页

### 第二步：提取访问码
1. 在售后详情页的"发货物流"模块中查找发货内容链接
2. 链接格式：`https://ghibliflowstudio.com/?c={访问码}`
3. 提取链接中的访问码（如：75babb7f2f）

### 第三步：查询访问码剩余次数
执行API调用：
```bash
curl --location --request GET 'https://ghibliflowstudio.com/api/access-codes/{访问码}' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer $GHIBLI_API_TOKEN'
```

返回结果示例：
```json
{
  "code": "75babb7f2f",
  "usesRemaining": 10,
  "isActive": true,
  "processingMode": "api"
}
```

### 第四步：展示订单信息并决策
查询到订单详情时，将以下信息展示给用户：

**订单信息：**
- 售后单号：[从页面提取]
- 商品名称：[从页面提取]
- 商品规格：[从页面提取]
- 申请金额：[从页面提取]
- 售后原因：[从页面提取]

**Access Code 信息：**
- 访问码：{访问码}
- 剩余次数：{usesRemaining}
- 初始次数：[根据商品规格计算]
- 已使用次数：[计算得出]
- 状态：{isActive ? '激活中' : '已禁用'}

**处理方案：**

根据查询结果进行判断：
- ✅ **情况一**：剩余次数 = 初始次数（即一次未使用）
  - 处理方案：自动全额退款 + 禁用 Access Code
  - 操作：直接执行第五步

- ❌ **情况二**：剩余次数 < 初始次数（即已使用过）
  - **⚠️ 重要提示**：需用户手动确认退款方案，**必须人工介入处理**
  - 操作：等待用户确认后执行第六步

**注意**：除了未使用场景（情况一）可自动处理外，所有其他场景（包括情况二）均需要人工手动确认处理方案后才能继续执行。

### 第五步：执行全自动全额退款（未使用场景）
当确认 Access Code 未使用时：

1. **在售后详情页点击"同意退款"按钮**
2. **在弹窗中点击"确定退款"按钮**
3. **确认退款状态变更为"已同意退款"**
4. **调用API禁用 Access Code**：
```bash
curl 'https://ghibliflowstudio.com/api/access-codes/{访问码}' \
  --compressed \
  -X PATCH \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer $GHIBLI_API_TOKEN' \
  -d '{"isActive": false}'
```

### 第六步：执行按比例部分退款操作（已使用场景）
**⚠️ 必须人工手动确认方案**

当 Access Code 已被使用时，**必须由用户手动确认处理方案**，禁止自动执行。请向用户展示计算信息并等待确认：

**计算退款金额：**
- 单次价格 = 商品总价 ÷ 标注总次数
- 已使用次数 = 标注总次数 - 剩余次数
- 可退金额 = 单次价格 × (标注总次数 - 已使用次数)
- 示例：生图10次 × ¥0.5/次 = ¥5.00，剩余8次，已使用2次，可退金额 = ¥5.00 × (10-2)/10 = ¥4.00

**用户确认后的操作流程：**
1. **首先尝试点击"拒绝"按钮**
   - 拒绝原因选择"其他"
   - 拒绝说明输入：`已使用{已使用次数}次，可退剩余部分{可退金额}元`

2. **如果系统提示需要协商，转为协商流程：**
   - **首先点击【经协商部分退款】**
   - **切换【售后类型】选择与原类型不同的选项：**
     - 原"仅退款 未收到货" → 选"仅退款 已收到货"
     - 原"仅退款 已收到货" → 选"仅退款 未收到货"
   - **修改【售后原因】选择"其他"**
   - **修改【售后金额】填入计算的金额**
   - **点击【自定义文案】修改文本为：`已使用{已使用次数}次，可退剩余部分{可退金额}元`**
   - **勾选【协商超时自动拒绝】**
   - **选择【拒绝原因-其他】**
   - **填写【拒绝说明】为：`已使用{已使用次数}次，可退剩余部分{可退金额}元`**
   - **点击【确认发送】**

3. **如果发起协商但是需要拒绝的话，页面会先弹出一个温馨提示对话框：**
   - **对话框内容**：`此售后单已向用户发起协商修改，用户还未确认，您确认要直接拒绝申请吗？`
   - **选项**：取消 | **确认拒绝**
   - **操作**：点击【确认拒绝】按钮，直接走拒绝流程

4. **如果已协商时间已经超出半个小时，可以详情页面直接点击拒绝**

### 第七步：关闭订单页面并继续处理
1. 完成退款操作后，关闭当前售后详情标签页
2. 继续处理下一个待审核订单

---

## 实际案例记录

### 案例一：自动全额退款（未使用场景）- P778424139418265051

**订单信息：**
- 售后单号：R0906152167392389
- 商品：拼豆图千帆图自助【10次】（规格：初始10次）
- 申请金额：¥5.00
- 售后原因：其他（买家说明：不需要了）

**发货内容：**
- 链接：https://ghibliflowstudio.com/?c=e1a0fac76e
- 访问码：e1a0fac76e

**API查询结果：**
```json
{
  "code": "e1a0fac76e",
  "usesRemaining": 9,
  "isActive": false,
  "processingMode": "api"
}
```

**信息展示给用户：**
- ✅ **决策**：剩余次数(9) < 初始次数(10)，已使用过，需用户确认

**处理结果：**
- 操作：用户确认按比例退款方案 → 执行协商流程
- 退款金额：¥0.50（已使用1次，可退剩余部分¥0.50）
- 处理时间：2025-11-12

---

### 案例二：直接退款（全额未使用）- P778419274809061521

**订单信息：**
- 售后单号：R0906152167392389
- 商品：拼豆图自助工具【10次】（规格：生图10次）
- 申请金额：¥4.99
- 售后原因：其他（买家说明：还没有用，太麻烦了）

**发货内容：**
- 链接：https://ghibliflowstudio.com/?c=75babb7f2f
- 访问码：75babb7f2f

**API查询结果：**
- 剩余次数：10次
- 状态：激活中
- 处理模式：API模式

**决策判断：**
- ✅ 商品标注：生图10次
- ✅ API查询：剩余10次
- **结论：符合条件，直接退款**

**处理结果：**
- 操作：点击同意退款 → 确认退款
- 状态：已同意退款
- 退款金额：¥4.99
- 退款时间：0天23时59分内退至原支付账号
- 处理时间：2025-11-11 22:31:41

---

## 注意事项
1. **环境配置**：必须配置 `.env` 文件中的 `GHIBLI_API_TOKEN` 环境变量
2. **商品筛选**：仅处理商品名称包含"自助工具"的订单，其他商品需人工处理
3. 每次处理前需要刷新页面确保数据最新
4. 使用 `toolbarAndList` class 直接定位列表页面，提高定位效率
5. 使用 `opera-item` class 精确筛选"查看详情"按钮，减少DOM元素定位时间
6. 完成订单处理后必须关闭订单详情标签页，避免标签页堆积影响性能
7. 确保API调用成功且返回正确的剩余次数
8. **信息展示**：查询订单后必须向用户展示完整的订单信息和Access Code状态
9. **自动化流程**：
   - 未使用的Access Code（剩余次数=初始次数）：自动全额退款+禁用Code
   - 已使用的Access Code（剩余次数<初始次数）：⚠️ 必须人工手动确认方案，**禁止自动执行**
10. **按比例退款计算**：使用公式精确计算退款金额，避免金额错误
11. **协商话术**：使用标准化文案"已使用X次，可退剩余部分X.X元"
12. 如果访问码无效或API调用失败，需要人工处理
13. **禁用Access Code**：全额退款后必须调用PATCH API禁用Code，设置 `isActive: false`
14. 建议批量处理前先测试单个订单流程
15. **网络请求方式**：不要使用 `chrome_inject_script` 进行网络请求，直接使用 curl bash 命令进行 API 调用

## 待优化点
1. 可以考虑集成批量API查询功能，提高处理效率
2. 添加异常情况处理日志
3. 支持更多商品类型和判断规则
